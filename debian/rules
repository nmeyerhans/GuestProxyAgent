#!/usr/bin/make -f

include /usr/share/dpkg/default.mk
include /usr/share/dpkg/architecture.mk

export DEB_BUILD_MAINT_OPTIONS = hardening=+all
ebpf_path:=linux-ebpf
CARGO_OPTS+=--verbose --manifest-path proxy_agent/Cargo.toml
BUILD_TYPE?=debug

%:
	dh $@

ifeq (release,$(BUILD_TYPE))
  CARGO_OPTS+=--release
endif

ifeq (,$(filter upstream-cargo, $(DEB_BUILD_PROFILES)))
# final offline build with packaged dependencies

include /usr/share/rustc/architecture.mk
export CARGO=/usr/share/cargo/bin/cargo
export CARGO_HOME=$(shell pwd)/debian/cargo_home
export CARGO_REGISTRY=$(shell pwd)/debian/cargo_registry
export DEB_CARGO_CRATE=$(DEB_SOURCE)_$(DEB_VERSION_UPSTREAM)
export DEB_HOST_RUST_TYPE

CARGO_OPTS+=--offline

execute_before_dh_auto_configure:
	$(CARGO) prepare-debian $(CARGO_REGISTRY) --link-from-system --manifest-path proxy_agent/Cargo.toml
	rm -f proxy_agent/Cargo.lock
	rm -f .cargo/config
endif

override_dh_auto_build:
	cargo build $(CARGO_OPTS) 
	clang -g -target bpf -O2 -I/usr/include/$(DEB_TARGET_GNU_TYPE) -D__TARGET_ARCH_x86 \
	  -c $(ebpf_path)/ebpf_cgroup.c -o $(ebpf_path)/ebpf_cgroup.o

execute_after_dh_auto_clean:
	cd proxy_agent && cargo clean --verbose
	rm -rf $(CARGO_HOME) debian/azure-guest-proxy-agent.service linux-ebpf/ebpf_cgroup.o
	rm -rf $(CARGO_REGISTRY)

override_dh_auto_test: out_dir=$(CURDIR)/proxy_agent/target/$(BUILD_TYPE)/deps
override_dh_auto_test:
ifneq (nocheck,$(findstring nocheck,$(DEB_BUILD_OPTIONS)))
	mkdir -p $(out_dir)
	cp -f -T proxy_agent/config/GuestProxyAgent.linux.json $(out_dir)/GuestProxyAgent.json
	cargo test --verbose --release --manifest-path proxy_agent/Cargo.toml -- --test-threads=1 \
	  --skip service::tests::test_check_service_installed --skip service::tests::test_install_service
endif

execute_after_dh_auto_install: TARGET=debian/azure-guest-proxy-agent
execute_after_dh_auto_install:
	install -o root -g root -m0755 target/$(BUILD_TYPE)/azure-proxy-agent \
          $(TARGET)/usr/sbin
	install -o root -g root -m0644 debian/proxy-agent.json \
          $(TARGET)/etc/azure/proxy-agent.json
	install -o root -g root -m0644 proxy_agent_setup/src/linux/azure-proxy-agent.service \
          debian/azure-guest-proxy-agent.service
	dh_installsystemd
