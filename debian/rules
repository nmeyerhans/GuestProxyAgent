#!/usr/bin/make -f


export DEB_BUILD_MAINT_OPTIONS = hardening=+all

include /usr/share/dpkg/default.mk
include /usr/share/rustc/architecture.mk
export CARGO=/usr/share/cargo/bin/cargo
export CARGO_HOME=$(shell pwd)/debian/cargo_home
export CARGO_REGISTRY=$(shell pwd)/debian/cargo_registry
export DEB_CARGO_CRATE=$(DEB_SOURCE)_$(DEB_VERSION_UPSTREAM)
export DEB_HOST_RUST_TYPE

ebpf_path:=linux-ebpf

%:
	dh $@

override_dh_auto_build:
	cargo build --offline --release --verbose --manifest-path proxy_agent/Cargo.toml
	clang -g -target bpf -O2 -I/usr/include/$(DEB_TARGET_GNU_TYPE) -D__TARGET_ARCH_x86 \
	  -c $(ebpf_path)/ebpf_cgroup.c -o $(ebpf_path)/ebpf_cgroup.o

execute_after_dh_auto_clean:
	cd proxy_agent && cargo clean --verbose
	rm -rf $(CARGO_HOME) debian/azure-guest-proxy-agent.service linux-ebpf/ebpf_cgroup.o
	rm -rf $(CARGO_REGISTRY)

execute_before_dh_auto_configure:
	$(CARGO) prepare-debian $(CARGO_REGISTRY) --link-from-system --manifest-path proxy_agent/Cargo.toml
	rm -f proxy_agent/Cargo.lock
	rm -f .cargo/config

#override_dh_auto_install:
#	cargo install --offline proxy_agent

execute_after_dh_auto_install:
	install -o root -g root -m0644 proxy_agent/config/GuestProxyAgent.linux.json \
	  debian/azure-guest-proxy-agent/etc/GuestProxyAgent.json
	cp proxy_agent_setup/src/linux/GuestProxyAgent.service debian/azure-guest-proxy-agent.service
	dh_installsystemd

override_dh_auto_test: out_dir=$(CURDIR)/proxy_agent/target/release/deps
override_dh_auto_test:
ifneq (nocheck,$(findstring nocheck,$(DEB_BUILD_OPTIONS)))
	cp -f -T proxy_agent/config/GuestProxyAgent.linux.json $(out_dir)/GuestProxyAgent.json
	cargo test --verbose --release --manifest-path proxy_agent/Cargo.toml -- --test-threads=1
endif
